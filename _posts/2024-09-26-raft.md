---
date: 2024-09-11
title: "MIT-6.5840-Raft"
category: å­¦ä¹ ç»éªŒ
tags: [MIT-6.5840,åˆ†å¸ƒå¼ç³»ç»Ÿ]
excerpt: "Raftè®ºæ–‡è§£è¯»ä»¥åŠlab3å®ç°æ€è·¯"
---


# Raftè®ºæ–‡è§£è¯»

ä»ä¸­å¤®é›†æƒï¼ˆå•masterï¼‰åˆ°è‡ªç”±æ°‘ä¸»çš„ä¼Ÿå¤§è¿‡æ¸¡ï¼ï¼ˆè™½ç„¶é€‰ä¸¾åä»ç„¶æ˜¯ä¸­å¤®é›†æƒï¼Œè€Œä¸”é›†æƒç¨‹åº¦æ¯”GFSè¿˜ä¸¥é‡ğŸ˜‚ğŸ˜‚ğŸ˜‚

TODO!!!

# Lab3å®ç°æ€è·¯

Raftè™½ç„¶å®£ç§°æ˜¯ä¸€ä¸ª**understandable**çš„ç®—æ³•ï¼Œè®ºæ–‡é˜…è¯»èµ·æ¥ideaç¡®å®å¾ˆç®€å•ï¼Œæ— éå°±æ˜¯æŠ•ç¥¨å˜›ï¼Œä½†å®é™…å®ç°èµ·æ¥å´è¦é¢å¯¹æ— é™çš„ç»†èŠ‚é—®é¢˜ï¼Œå®ç°èµ·æ¥æå…¶éº»çƒ¦ï¼Œå†æ¬¡éªŒè¯äº†*Talk is cheap*çš„ä¸å˜çœŸç†

**æå‰è¯´æ˜ä¸‹ï¼š**

å› ä¸ºä¸‹é¢çš„å†…å®¹éƒ½æ˜¯åœ¨ä¸€ä¸ªé˜¶æ®µå®Œæˆä¹‹åå†™çš„ï¼Œåç»­å¯èƒ½ä¼šæœ‰ä¸€äº›ç»†èŠ‚ä¸Šçš„æ›´æ”¹è®©ä¹‹å‰çš„è¡¨è¿°ä¸å†ç¬¦åˆæœ€ç»ˆçš„ä»£ç ï¼Œä½†è‡³å°‘æ¯ä¸€ä¸ªé˜¶æ®µåœ¨ç»“æŸå‰éƒ½è¿›è¡Œè‡³å°‘ç™¾æ¬¡çš„æµ‹è¯•ï¼Œæ˜¯å¯ä»¥ä¿è¯æ­£ç¡®æ€§çš„

## Part 3A: leader election

è™½ç„¶åªæ˜¯ä¸€ä¸ªåˆšåˆšå¼€å§‹çš„éƒ¨åˆ†ï¼Œéš¾åº¦è¯„çº§ä¹Ÿåªæœ‰moderateï¼Œä½†ä¸ªäººå‰åèŠ±è´¹äº†å°†è¿‘ä¸‰å¤©æ‰å®Œæˆè¿™ä¸€éƒ¨åˆ†ã€‚æœ€åçš„ç»“æœæ˜¯æˆåŠŸè¿ç»­è¿›è¡Œäº†200å¤šæ¬¡å®éªŒæ‰å¤±è´¥ï¼Œè€ƒè™‘åˆ°rafté€‰ä¸¾çš„éšæœºæ€§ï¼Œåº”è¯¥æ˜¯å¯ä»¥æ¥å—çš„ç»“æœã€‚å®ç°çš„ä»£ç ä¸å¤šï¼Œå¤§æ¦‚å®é™…ç¼–å†™çš„åªæœ‰ä¸¤ä¸‰ç™¾è¡Œå·¦å³ï¼Œä¸‹é¢ä¸»è¦è¯´è¯´å®ç°æ€è·¯å’Œä¸€äº›è¸©åˆ°çš„å‘

### å‡†å¤‡å·¥ä½œ

**è®ºæ–‡çš„Figure 2éå¸¸çš„é‡è¦ï¼ï¼ï¼**

**è®ºæ–‡çš„Figure 2éå¸¸çš„é‡è¦ï¼ï¼ï¼**

**è®ºæ–‡çš„Figure 2éå¸¸çš„é‡è¦ï¼ï¼ï¼**

![](/assets/images/2024-09-26-raft/Figure1.png)

åœ¨å¼€å§‹å‰ä¸€å®šè¦å°†æ¯ä¸€æ¡è¡Œä¸ºéƒ½çœ‹ä¸€éï¼Œåœ¨å®ç°æ—¶ä¹Ÿè¦ä¸æ–­åœ°å¯¹ç…§è¿™å¼ å›¾çš„è¯­ä¹‰æ¥å®ç°ï¼Œåœ¨æœ¬éƒ¨åˆ†æ‰€æœ‰è¸©åˆ°çš„å‘å¤§éƒ¨åˆ†éƒ½æ˜¯å› ä¸ºæ²¡æœ‰ä»”ç»†çœ‹è¿™å¼ å›¾å¯¼è‡´çš„ã€‚ã€‚ã€‚

### è¶…æ—¶è§¦å‘å™¨

raftçš„æ ¸å¿ƒå°±åœ¨äºå¿ƒè·³åŒ…è¶…æ—¶åå¼€å¯çš„é€‰ä¸¾ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥æˆ‘é€‰æ‹©å…ˆå®ç°è¶…æ—¶çš„å¤„ç†


æ¡†æ¶ä»£ç ç»™æˆ‘ä»¬å‡†å¤‡äº†åŸºç¡€çš„é€»è¾‘ï¼Œå³å‘¨æœŸåœ°åˆ¤æ–­æœåŠ¡å™¨æ˜¯å¦æ­»äº¡ï¼Œå¦‚æœæ²¡æœ‰æ­»äº¡å°±è¿›è¡Œè¶…æ—¶æ£€æŸ¥

åœ¨æœåŠ¡å™¨çš„æ•°æ®ç»“æ„ä¸­è®°å½•å¥½ä¸Šä¸€æ¬¡çš„å¿ƒè·³æ—¶é—´æˆ³ï¼Œå‘½åä¸º`lastHeartBeat`ï¼Œåœ¨åˆ¤æ–­æ—¶ä½¿ç”¨`time.Since(rf.lastHeartBeat) > TM_ElectionTimeout`å³å¯åˆ¤æ–­æ˜¯å¦å®Œæˆæ£€æŸ¥

æ¥ç€æ ¹æ®è®ºæ–‡ä¸­æåˆ°çš„éšæœºåŒ–ç­–ç•¥ï¼Œè¿›è¡Œéšæœºçš„æ—¶é—´æš‚åœï¼Œéšåå¯åŠ¨é€‰ä¸¾

é€»è¾‘ä¸Šå°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œä½†æ˜¯æœ‰å‡ ä¸ªç»†èŠ‚éœ€è¦æ³¨æ„

1. 
    éšæœºçš„æ—¶é—´æš‚åœåï¼Œåº”è¯¥å†æ¬¡åˆ¤æ–­å¿ƒè·³æ—¶é—´æ˜¯å¦è¢«åˆ·æ–°ï¼Œè§’è‰²æ˜¯å¦è¢«æ›´æ”¹ã€‚è¿›è¡Œè¿™äº›åˆ¤æ–­ä¿è¯å¼€å¯é€‰ä¸¾æ—¶æœåŠ¡å™¨ä¸€å®šå¤„äºè¶…æ—¶å¹¶ä¸”è§’è‰²æ˜¯Candidateï¼Œé¿å…æ²¡æœ‰å¿…è¦çš„é€‰ä¸¾

2. 
    é€‰ä¸¾åº”è¯¥è¦åœ¨ä¸€ä¸ªæ–°çš„çº¿ç¨‹ä¸­å¯åŠ¨ï¼Œç„¶ååˆ·æ–°å¿ƒè·³æ—¶é—´ï¼Œå›åˆ°ä¸»å¾ªç¯ç­‰å¾…ä¸‹ä¸€æ¬¡è¶…æ—¶æˆ–è€…æˆä¸ºLeader

    åœ¨æœ€å¼€å§‹çš„å®ç°ä¸­ï¼Œæ¯ä¸€ä¸ªé€‰ä¸¾éƒ½åœ¨ä¸»çº¿ç¨‹ä¸­å¼€å¯ï¼Œé€‰ä¸¾å¤±è´¥è¶…æ—¶ç”±å¦å¤–çš„è®¡æ—¶å™¨æ¥å†³å®šã€‚è¿™æ ·åšè®©å‚ä¸å½“å‰é€‰ä¸¾çš„Candidateæ— æ³•å‚ä¸åˆ°ä¸‹ä¸€è½®çš„é€‰ä¸¾ä¸­ï¼Œè€Œç†è®ºä¸Šæ‰€æœ‰çš„Candidateå‚ä¸çš„æœºä¼šæ˜¯å‡ç­‰çš„

ä¸‹é¢æ˜¯å®ç°çš„ä»£ç ï¼ˆè™½ç„¶å¤©å¤©è¯´[å­¦æœ¯è¯šä¿¡](https://integrity.mit.edu/)ï¼Œä½†æ˜¯æœç„¶è¿˜æ˜¯ä»£ç çš„è¯´æ˜æ›´åŠ æ–¹ä¾¿ï¼‰ï¼š
```go
func (rf *Raft) ticker() {
    for !rf.killed() {
        // Check if a leader election should be started.
        rf.mu.Lock()

        // Heart beat timeout
        if rf.state != RS_Leader && time.Since(rf.lastHeartBeat) > TM_ElectionTimeout {
            log.Printf("[%v] heart beat timeout\n", rf.me)
            rf.state = RS_Candiate
            log.Printf("[%v] turn to candiate\n", rf.me)
            // randomization
            rf.mu.Unlock()
            ms := (rand.Int63() % int64(TM_RandomWaitingTime))
            time.Sleep(time.Duration(ms))
            rf.mu.Lock()

            // Start an election, if other one win the election, state will not be Candiate
            // or voting to someone that reset heartbeat time
            if rf.state != RS_Candiate || time.Since(rf.lastHeartBeat) < TM_ElectionTimeout {
                rf.mu.Unlock()
            } else {
                rf.lastHeartBeat = time.Now() // reset election timer
                rf.mu.Unlock()
                go rf.election()
            }
        } else {
            rf.mu.Unlock()
        }

        // pause for a random amount of time between 50 and 350
        // milliseconds.
        ms := 50 //+ (rand.Int63() % 300)
        time.Sleep(time.Duration(ms) * time.Millisecond)
    }
}
```

### é€‰ä¸¾

è¶…æ—¶åå°±åˆ°äº†ç´§å¼ åˆºæ¿€çš„é€‰ä¸¾æ—¶é—´

#### é€»è¾‘å®ç°

æŒ‰ç…§è®ºæ–‡Figure 2çš„é€»è¾‘ï¼ŒCandidateåœ¨å¼€å¯é€‰ä¸¾æ—¶è¦åšçš„æ˜¯

1. å¢åŠ è‡ªèº«çš„ä»»æœŸå·

2. å°†ç¥¨æŠ•ç»™è‡ªå·±

3. é‡ç½®é€‰ä¸¾è¶…æ—¶è®¡æ—¶å™¨

4. å‘æ‰€æœ‰çš„æœåŠ¡å™¨å‘èµ·RequestVote RPC

å¢åŠ è‡ªèº«ä»»æœŸå·æ˜¯ä¸ºäº†å¼€å¯ä¸€ä¸ªæ–°çš„é€‰ä¸¾ä»»æœŸï¼Œåœ¨åˆšå¼€å§‹çš„æ–°ä»»æœŸä¸­ï¼Œè¯¥å€™é€‰äººä¸€å®šè¿˜æ²¡æœ‰è¿›è¡Œè¿‡æŠ•ç¥¨ï¼Œæ‰€ä»¥å¯ä»¥ä¿è¯å°†ç¥¨æŠ•ç»™è‡ªå·±

é‡ç½®è¶…æ—¶è®¡æ—¶å™¨æˆ‘å°†å…¶æ”¾åˆ°äº†å¼€å¯é€‰ä¸¾çº¿ç¨‹ä¹‹åçš„ä¸»çº¿ç¨‹è¡Œä¸ºä¸­

æ¥ç€å‘æ‰€æœ‰çš„æœåŠ¡å™¨å¹¶è¡Œåœ°å‘èµ·RequestVote RPCï¼Œè¦æ³¨æ„RPCæ˜¯ä¼šéšæœºå¤±è´¥çš„ï¼Œæ‰€ä»¥æ ¹æ®è®ºæ–‡æˆ‘ä»¬è¦`indefinitely`å‘é€RPCï¼Œä½†æ˜¯è‚¯å®šä¸èƒ½çœŸçš„æ— é™åœ°å‘é€ï¼Œå½“è¿™æ¬¡é€‰ä¸¾å¤±æ•ˆåè¦ä¸»åŠ¨åœæ­¢ï¼Œåœæ­¢çš„æœºåˆ¶åç»­ä»‹ç»

å½“å—åˆ°è‚¯å®šçš„å›å¤åï¼Œé€’å¢é€‰ä¸¾ç¥¨æ•°è®¡æ•°å™¨

åœ¨å¯åŠ¨äº†æ‰€æœ‰çš„å‘é€RPCçš„çº¿ç¨‹åï¼Œåœ¨é€‰ä¸¾ä¸»çº¿ç¨‹ä¸Šè¿›è¡Œè½®è¯¢ç­‰å¾…ç¥¨æ•°è¶…è¿‡å¤šæ•°æˆ–è¯¥æ¬¡é€‰ä¸¾å¤±è´¥

#### è¯¥æ¬¡é€‰ä¸¾å¤±è´¥

åœ¨å®ç°ä¸­ï¼Œæœ€è®©äººå¤´ç–¼çš„å°±æ˜¯å¦‚ä½•å¤„ç†å¤±è´¥çš„é€‰ä¸¾

å¤±è´¥å¯ä»¥ç”±ä»¥ä¸‹å‡ ä¸ªåŸå› å¯¼è‡´

1. é€‰ä¸¾è¶…æ—¶ï¼Œå¼€å¯äº†ä¸‹ä¸€è½®é€‰ä¸¾ï¼Œè¯¥è½®é€‰ä¸¾å¤±æ•ˆ

2. æ”¶åˆ°äº†æ¥è‡ªç›¸åŒæˆ–æ›´é«˜ä»»æœŸçš„å¿ƒè·³åŒ…ï¼Œè¯´æ˜è¯¥è½®æˆ–è€…æ›´é«˜è½®å·²å‡ºç°èƒœè€…

3. å‘é€çš„RequestVote RPCè¢«ä¸€ä¸ªæ‹¥æœ‰æ›´é«˜ä»»æœŸå·çš„æœºå™¨å›å¤ï¼Œè¯´æ˜å½“å‰é€‰ä¸¾å‘¨æœŸå·²ç»å¤±æ•ˆ

1ï¼Œ2éƒ½æ˜¯å’Œå½“å‰é€‰ä¸¾æ´»åŠ¨æ— å…³çš„ï¼Œå®ƒä»¬ç”±å…¶ä»–çº¿ç¨‹çš„è¡Œä¸ºè§¦å‘ï¼Œ3æ˜¯åœ¨å¤„ç†äº†RequestVote RPCçš„è¿”å›å€¼åå‘ç”Ÿçš„

ä½†å¥½åœ¨å®ƒä»¬éƒ½ä¼šå¯¼è‡´ä¸€æ ·çš„å½±å“ï¼šä»»æœŸå·æ›´æ–°åˆ°æ›´é«˜çš„å€¼æˆ–è€…è§’è‰²å˜åŒ–ä¸ºFollowerï¼Œä¹Ÿå¯èƒ½ä¸¤è€…éƒ½å‘ç”Ÿ

æ‰€ä»¥å¦‚æœè¦ç»ˆæ­¢æ— é™åˆ¶çš„RPCè¯·æ±‚æˆ–è€…é€‰ä¸¾ä¸»çº¿ç¨‹çš„ç­‰å¾…ï¼Œåªéœ€è¦å…³æ³¨ä»»æœŸå·æˆ–è€…è§’è‰²çš„å˜åŒ–å³å¯

å¦‚æœä»»æœŸå·ä¸å†å’Œå¼€å§‹é€‰ä¸¾æ—¶ä¸€è‡´ï¼Œè¯´æ˜å¤±è´¥

å¦‚æœè§’è‰²ä¸å†æ˜¯Candidateï¼Œä¹Ÿè¯´æ˜å¤±è´¥

**ä¸‹é¢æ˜¯å¹¶è¡Œå‘èµ·RPCçš„ä»£ç ï¼š**

åªæœ‰åœ¨ç¡®å®šäº†`isCandiate`å’Œ`isSameTerm`çš„æƒ…å†µä¸‹æ‰ä¼šå‘èµ·RPCï¼Œå¦åˆ™ç›´æ¥é€€å‡ºçº¿ç¨‹

å½“RPCçš„æ”¶åˆ°ä¸€ä¸ªæ¥è‡ªæ›´é«˜ä»»æœŸçš„å›å¤æ—¶ï¼Œå°†ä»»æœŸå·æ›´æ–°åˆ°å›å¤ç›¸åŒï¼Œé‡ç½®çŠ¶æ€ï¼Œç­‰å¾…è¯¥å€™é€‰äººå‘é€RPCæ—¶ç»™å®ƒæŠ•ç¥¨

æ³¨æ„è¿™é‡Œæœ‰ä¸€ä¸ª**ç»†èŠ‚**ï¼Œé‡ç½®çŠ¶æ€åœ¨æ‰€æœ‰å¹¶è¡Œçš„çº¿ç¨‹ä¸­åº”è¯¥åªèƒ½å‘ç”Ÿä¸€æ¬¡ï¼Œå¦‚æœå› ä¸ºæ—¶åºé—®é¢˜å¤šæ¬¡é‡ç½®çŠ¶æ€å¯èƒ½å°±ä¼šå‡ºç°åœ¨åŒä¸€ä»»æœŸå°†ç¥¨æŠ•ç»™å¤šä¸ªäººçš„æƒ…å†µ

```go
votedForTerm := rf.currentTerm
votedForCandiate := rf.me
isCancel := false

for i := range rf.peers {
    if i == rf.me {
        continue
    }

    go func(num int) {
        reply := RequestVoteReply{}

        // repeat sending vote request
        ok := false
        for !ok {
            rf.mu.Lock()
            isCandiate := rf.state == RS_Candiate
            isSameTerm := rf.currentTerm == votedForTerm
            rf.mu.Unlock()
            if isCandiate && isSameTerm {
                ok = rf.sendRequestVote(num, &args, &reply)
            } else {
                return
            }
        }
        // log.Printf("[%v] send RequestVote to [%v] successfully\n", votedForCandiate, num)

        if !reply.VoteGranted && reply.Term > votedForTerm { // if there is a higher term, stop election
            rf.mu.Lock()

            // only stop once
            if !isCancel {
                rf.currentTerm = reply.Term
                rf.state = RS_Follower
                rf.votedFor = nil
                log.Printf("[%v] stop election because [%v] has higher term, turn to follower\n", votedForCandiate, num)
                isCancel = true
            }

            rf.mu.Unlock()
        } else if reply.VoteGranted { // granted!
            ballotMutex.Lock()
            ballotCount += 1
            ballotMutex.Unlock()
            log.Printf("[%v] get ballot from [%v]", votedForCandiate, num)
        }
    }(i)
}
```

é€‰ä¸¾ä¸»çº¿ç¨‹åšçš„åˆ¤æ–­ä¹Ÿç±»ä¼¼ï¼Œå…³æ³¨ä»»æœŸå·çš„å˜åŒ–æˆ–è€…è§’è‰²çš„å˜åŒ–ï¼Œæ­¤å¤„ä¸å†åˆ—ä¸¾

#### èµ¢å¾—é€‰ä¸¾

å½“å¾—åˆ°çš„æŠ•ç¥¨è¶…è¿‡ä¸€åŠï¼ˆ`ballot >= len(rf.peers)/2+1`ï¼ŒåŒ…æ‹¬è‡ªèº«çš„é‚£ä¸€ç¥¨)ï¼Œå¹¶ä¸”å½“å‰ç¡®å®å¤„äºCandidateçš„è§’è‰²ï¼Œåˆ™è¯¥å€™é€‰äººæˆä¸ºLeader

æ¥ç€å¼€å¯å‘é€å¿ƒè·³åŒ…çš„çº¿ç¨‹ï¼Œç„¶åç»“æŸé€‰ä¸¾çº¿ç¨‹

å‘èµ·å¿ƒè·³åŒ…çš„çº¿ç¨‹å°±æ˜¯ä¸æ–­å‘èµ·`AppendEntries`ï¼Œä½†æ˜¯`Entries`å­—æ®µä¸ºç©ºï¼Œå…¶æ‰€åšçš„ç»“æŸåˆ¤æ–­å’Œé€‰ä¸¾ä¸­æ‰€åšçš„åŸºæœ¬ä¸€è‡´ï¼Œä¸å†èµ˜è¿°

### ä¸¤ç§RPCçš„è¡Œä¸º

Raftä¸ºäº†ç®€åŒ–è®¾è®¡ï¼Œå¢å¼ºè‡ªèº«çš„å¯ç†è§£æ€§ï¼Œåªè®¾è®¡äº†ä¸¤ç§RPCå³å¯å®Œæˆæ‰€æœ‰çš„ä»»åŠ¡

å°†å¿ƒè·³åŒ…åˆå¹¶åˆ°æ·»åŠ æ¡ç›®RPCç¡®å®æ˜¯ä¸€ä¸ªèªæ˜çš„åšæ³•

#### AppendEntries

è¿˜æ˜¯é‚£å¥è¯ï¼Œä¸€å®šè¦ä»”ç»†é˜…è¯»è®ºæ–‡Figure2çš„è¯´æ˜ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½å·²ç»è¢«å®šä¹‰å¥½äº†

å½“æ¥å—åˆ°æ¥è‡ªä»»æœŸæ›´ä½çš„RPCè¯·æ±‚ï¼Œæ¥å—è€…é€‰æ‹©æ‹’ç»è¯¥RPCï¼Œç„¶åå°†è‡ªå·±çš„ä»»æœŸå·è¿”å›ç»™å‘é€è€…ã€‚

å‘é€è€…æ¥å—åˆ°å›å¤åå¦‚æœå‘ç°å‘ç°è‡ªå·±çš„ä»»æœŸå·ä½äºä¸€ä¸ªç°æœ‰çš„æœºå™¨ï¼Œåˆ™æ”¾å¼ƒLeaderçš„æƒé™ï¼Œè½¬å˜ä¸ºfollowerï¼Œæå‡ä»»æœŸä¸å›å¤ä¸­çš„ç›¸åŒ

å¦‚æœè¯¥RPCçš„å‘é€æ–¹ä»»æœŸå¤§äºæˆ–ç­‰äºæ¥å—è€…ï¼Œæ— è®ºç°åœ¨çš„çŠ¶æ€æ€ä¹ˆæ ·ï¼Œéƒ½è½¬å˜ä¸ºFollowerï¼ŒåŒæ—¶åŒæ­¥ä»»æœŸå·ï¼ˆå¦‚æœæ­¤æ—¶æ¥å—è€…æ­£å¤„äºé€‰ä¸¾çŠ¶æ€ï¼Œåˆ™ä¼šå¯¼è‡´äº†å‰é¢æåˆ°çš„é€‰ä¸¾å¤±è´¥ï¼‰

ç„¶åæ¥å—è€…é‡ç½®å¿ƒè·³è®¡æ—¶å™¨ï¼Œé¿å…è¶…æ—¶

åœ¨è¿™ä¸ªé˜¶æ®µçš„AppendEntries RPCè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œåªæ‰¿æ‹…å¿ƒè·³çš„ä½œç”¨ï¼Œä½†æ˜¯åˆ°äº†åé¢çœŸæ­£å®ç°æ—¥å¿—çš„æ—¶å€™å°±éœ€è¦å¤§æ”¹ç‰¹æ”¹è¿™ä¸ªè®¾è®¡äº†

#### RequestVote

åœ¨å½“å‰é˜¶æ®µçš„RequestVoteä¸­ï¼Œå› ä¸ºæ—¥å¿—æ²¡æœ‰ä»»ä½•çš„æ·»åŠ ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰é€»è¾‘åˆ¤æ–­æ—¥å¿—çš„é«˜ä½ä¸å¦

ä¸€ä¸ªæ¥å—è€…æ ¹æ®æ¥å—åˆ°çš„RequestVoteä¸­çš„ä»»æœŸä¿¡æ¯ï¼Œä½œå‡ºä»¥ä¸‹ååº”

1. **å‘é€è€…çš„ä»»æœŸå·å°äºæ¥å—è€…**

    è¿™ä¸ªæƒ…å†µä¸‹å’ŒAppendEnriesæ˜¯ä¸€æ ·çš„ï¼Œæ¥å—è€…æ‹’ç»è¯¥è¯·æ±‚ï¼ŒåŒæ—¶å°†è‡ªå·±çš„ä»»æœŸè¿”å›å›å»ï¼Œå‘é€è€…å°±å¯ä»¥æ ¹æ®è¿”å›çš„ä»»æœŸæ¥åˆ¤æ–­è‡ªå·±æ˜¯å¦è¦ç»§ç»­æ‹…ä»»Leader

2. **å‘é€è€…çš„ä»»æœŸå·å¤§äºæ¥å—è€…**

    æ­¤å¤„çš„å¤§äºæ˜¯**ä¸¥æ ¼å¤§äº**ï¼Œå½“æ¥å—è€…å‘ç°è‡ªå·±çš„ä»»æœŸè½åäºå‘é€è€…ï¼Œåˆ™æé«˜è‡ªå·±çš„ä»»æœŸå·å’Œå‘é€è€…ç›¸åŒï¼Œå°†`votedFor`ç½®ä¸ºnullï¼Œè½¬å˜ä¸ºFollowerï¼Œç­‰å¾…è¿›è¡Œä¸‹ä¸€æ­¥çš„åˆ¤å®š

3. **å‘é€è€…çš„ä»»æœŸå·ç­‰äºæ¥å—è€…**

    å¦‚æœä»»æœŸå·ç›¸åŒï¼Œ åˆ™åˆ¤å®šè¯¥ä»»æœŸå†…æ˜¯å¦å·²ç»å°†ç¥¨æŠ•ç»™äº†æŸäººï¼ˆé€šè¿‡åˆ¤å®š`votedFor`æ˜¯å¦ä¸ºnullï¼‰ã€‚å¦‚æœæ²¡æœ‰åˆ™ä¿®æ”¹`votedFor`ä¸ºå‘é€è€…çš„Idï¼Œå›å¤è‚¯å®šçš„æ¶ˆæ¯ç»™å‘é€è€…ã€‚

æ³¨æ„ä»¥ä¸Šçš„çŠ¶æ€ä¸æ˜¯ä½¿ç”¨if elseè€Œæ˜¯é¡ºåºåœ°åˆ¤å®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´è§¦å‘äº†æ¡ä»¶2çš„æ¥å—è€…å¯ä»¥å‚ä¸æ¡ä»¶3çš„åˆ¤å®šã€‚æ‰€ä»¥ä¸€ä¸ªä»»æœŸå·è½åçš„æœºå™¨å¦‚æœæ”¶åˆ°äº†æ¥è‡ªé«˜ä»»æœŸçš„RequestVoteå°±ä¼šé©¬ä¸Šå°†ç¥¨æŠ•ç»™è¯¥å‘é€è€…ï¼Œå› ä¸ºæ¡ä»¶2ä¼šæŠŠ`votedFor`ç½®ä¸ºnull

### votedFor

åˆ°æ­¤Part 3Aä»å¯åŠ¨å¼€å§‹åˆ°é€‰ä¸¾åå‘é€heart beatçš„æœºåˆ¶æŒ‰ç…§æ‰§è¡Œçš„å…ˆåé¡ºåºè®²å®Œäº†ï¼Œä¸‹é¢è¯´è¯´åœ¨å®ç°ä¸­ï¼Œä¸€ç›´å›°æ‰°æˆ‘çš„ä¸€ä¸ªæ¦‚å¿µï¼š`votedFor`

éå¸¸é—æ†¾è®ºæ–‡ä¸­å¹¶æ²¡æœ‰æ€ä¹ˆè¯¦ç»†æåŠè¿™ä¸€å±æ€§åˆ°åº•è¦å¦‚ä½•å˜åŒ–ï¼Œæœ‰é™çš„è®¨è®ºå¦‚ä¸‹ï¼š

> **votedFor**: candidateId that received vote in current term (or null if none)

> If **votedFor** is null or candidateId, and candidateâ€™s log is at
least as up-to-date as receiverâ€™s log, grant vote

ç¬¬ä¸€æ¡æåˆ°`votedFor`æ˜¯ç”¨æ¥è¿½è¸ªå½“å‰ä»»æœŸè¯¥æœºå™¨å°†ç¥¨æŠ•ç»™äº†è°ã€‚åœ¨æœ€å¼€å§‹æˆ‘ä¸€ç›´ä¸ç†è§£å•ä¸€çš„å˜é‡è¦æ€ä¹ˆè¿½è¸ªå¤šä¸ªä»»æœŸä¸‹æ€ä¹ˆæŠ•ç¥¨çš„ï¼Œè¿˜æƒ³ç€è¦ä¸è¦å»ºç«‹ä¸€ä¸ªæ•°ç»„æ¥è¿½è¸ªæ‰€æœ‰ä»»æœŸä¸‹çš„æŠ•ç¥¨æƒ…å†µ

ä½†æ˜¯åç»­æˆ‘æ‰æ˜ç™½ä¸ºä»€ä¹ˆåªéœ€è¦ä¸€ä¸ªæ•°ç»„å°±å¯ä»¥ç»´æŠ¤æ‰€æœ‰ä»»æœŸçš„æŠ•ç¥¨æƒ…å†µã€‚å› ä¸ºä»»æœŸ`term`å’Œ`votedFor`æ˜¯ä¸¥æ ¼ç»‘å®šçš„ã€‚åªè¦ä»»æœŸå·å‘ç”Ÿå˜åŒ–ï¼Œ`votedFor`ä¸€å®šä¹Ÿè·Ÿç€å˜åŒ–ï¼ˆæŠ•ç»™è‡ªå·±æˆ–è€…å˜ä¸ºnilï¼‰

è®©æˆ‘ä»¬æ¥ç»†æ•°ä¸‹`votedFor`åœ¨ç›®å‰çš„å®ç°ä¸­ä¼šå‘ç”Ÿå˜åŒ–çš„æƒ…å†µ

1. å¯åŠ¨æ—¶`votedFor`è¢«åˆå§‹åŒ–ä¸ºnull

1. åœ¨æ¥æ”¶RequestVote RPCæ—¶ï¼Œæ¥å—è€…ä»»æœŸå·ä½äºå‘é€è€…ä»»æœŸå·ã€‚æ¥å—è€…å°†ä»»æœŸå·æ›´æ–°è‡³å‘é€è€…çš„ä»»æœŸå·ï¼ŒåŒæ—¶å°†`votedFor`ç½®ä¸ºnull

2. RequestVote RPCä¸­ï¼Œæ¥å—è€…å°†ç¥¨æŠ•ç»™äº†å‘é€è€…ï¼Œå°†`votedFor`æ›´æ–°ä¸ºå‘é€è€…çš„Idï¼Œæ­¤æ—¶å‘é€è€…å’Œæ¥å—è€…ä»»æœŸå·ä¸€å®šç›¸åŒ

3. ä¸€ä½å€™é€‰äººå‘èµ·äº†ä¸€è½®é€‰ä¸¾ï¼Œå®ƒè‡ªå¢è‡ªå·±çš„ä»»æœŸå·ï¼Œç„¶åå°†`votedFor`è®¾ç½®ä¸ºè‡ªå·±çš„Idå·

4. å€™é€‰äººå¼€å¯é€‰ä¸¾åï¼Œå‘å…¶ä»–æœºå™¨å‘èµ·RequestVoteæ—¶ï¼Œå—åˆ°ä¸€ä½ä»»æœŸæ¯”å®ƒé«˜çš„æœºå™¨çš„æ‹’ç»å›å¤ã€‚è¯¥å€™é€‰äººå°†ä»»æœŸå·æ›´æ–°è‡³å›å¤è€…ï¼Œå˜ä¸ºFollowerï¼Œç„¶åå°†`votedFor`è®¾ç½®ä¸ºnull

5. ä¸€ä½Leaderåœ¨å‘é€å¿ƒè·³åŒ…æ—¶ï¼Œå—åˆ°äº†ä¸€ä½ä»»æœŸå·æ¯”å®ƒå¤§çš„æœºå™¨çš„å›å¤ã€‚è¯¥å€™é€‰äººå°†ä»»æœŸå·æ›´æ–°è‡³å›å¤è€…ï¼Œå˜ä¸ºFollowerï¼Œç„¶åå°†`votedFor`è®¾ç½®ä¸ºnull

å¯ä»¥çœ‹åˆ°ï¼Œä¸¤è€…çš„å˜åŒ–æ˜¯ä¸¥æ ¼ç»‘å®šçš„ã€‚ä»»æœŸå·çš„å˜åŒ–ä¸€å®šä¼šä½¿`votedFor`å‘ç”Ÿå˜åŒ–ã€‚è€Œ`votedFor`åœ¨ä¸€ä¸ªä»»æœŸå†…è¦å‘ç”Ÿæ›´æ”¹çš„å‰ææ˜¯å®ƒä¸ºnullå³è¿˜æ²¡æœ‰æŠ•ç¥¨ç»™ä»»ä½•äººï¼Œä»æ­¤ä¿è¯äº†åœ¨ä¸€ä¸ªå‘¨æœŸå†…ä¸ä¼šå‡ºç°å¤šæŠ•ç¥¨çš„é—®é¢˜

ä¸è¿‡æœ‰ä¸€è¯´ä¸€ï¼Œè®ºæ–‡ä¸­å…³äº`votedFor`çš„å¦å¤–ä¸€æ¡æè¿°è®©äººè´¹è§£ï¼Œä¼¼ä¹æ˜¯å› ä¸ºè®ºæ–‡çš„åšæ³•æ˜¯ä¸æ–­åœ°å‘é€RequestVote RPCç›´åˆ°è¶…è¿‡åŠæ•°çš„æœºå™¨å›å¤è¿‡è‚¯å®šï¼Œè¯¥å€™é€‰äººæˆä¸ºLeaderä¸ºæ­¢ã€‚è€Œæˆ‘çš„åšæ³•æ˜¯åªè¿›è¡Œä¸€æ¬¡æˆåŠŸçš„RPCï¼Œå¦‚æœæˆåŠŸé€’å¢è®¡æ•°å™¨ï¼Œé è®¡æ•°å™¨æ¥åˆ¤æ–­æ˜¯å¦è¶…è¿‡äº†åŠæ•°ã€‚

æ‰€ä»¥è®ºæ–‡ä¸­è¯´åˆ°RequestVoteçš„æ¥å—è€…å¦‚æœ`votedFor`å’Œ`CandiateId`ä¸€è‡´ä¹Ÿè¿”å›è‚¯å®šçš„å›å¤

ä½†è¿™æ ·çš„åšæ³•æ„Ÿè§‰é™¤äº†æµªè´¹äº†ç½‘ç»œèµ„æºä»¥å¤–å°±æ²¡æœ‰ä»»ä½•æ„ä¹‰äº†ï¼ˆä¸çŸ¥é“æ˜¯ä¸æ˜¯æˆ‘ç†è§£é”™äº†ï¼‰

Anywayï¼Œè‡³å°‘åœ¨ç›®å‰çš„æœºåˆ¶ä¸‹ï¼Œ`votedFor`å¾ˆå¥½åœ°è§£å†³äº†é‡å¤æŠ•ç¥¨çš„é—®é¢˜


## Part 3B: log

è¯„çº§ç»™åˆ°äº†hardï¼Œç¡®å®å¾ˆéš¾ã€‚å›½åº†æœŸé—´æ‹¼æ‹¼å‡‘å‡‘æäº†å››å¤©æ‰æå®šã€‚æ¯å¤©å¤§æ¦‚èŠ±äº†å››äº”ä¸ªå°æ—¶åœ¨è¿™ä¸Šé¢

ç†å¿µéƒ½å¾ˆç®€å•ï¼Œä½†æ˜¯å®ç°èµ·æ¥å°±è¦é¢å¯¹æ— é™çš„ç»†èŠ‚ï¼Œfuck systemï¼

### å¤ç›˜

åœ¨ä»‹ç»å‰å…ˆè‡ªæˆ‘å¤ç›˜ä¸€ä¸‹å®ç°è¿‡ç¨‹çš„ä¸€äº›é—®é¢˜ï¼Œåšä¸€ä¸‹æ€»ç»“

1. **éµå¾ªpaperçš„æŒ‡å¯¼**

    äº‹åçœ‹æ¥ï¼Œå¤§éƒ¨åˆ†é—®é¢˜çš„æ ¹æºéƒ½æ˜¯æ²¡æœ‰ä»”ç»†é˜…è¯»è®ºæ–‡çš„Figure 2ã€‚æˆ‘è¦åšçš„æ˜¯æŒ‰ç…§paperçš„æŒ‡å¯¼å®ç°ä¸€ä¸ªç³»ç»Ÿï¼Œè€Œä¸æ˜¯è¦åˆ›æ–°ä¸€ä¸ªæ–°ç³»ç»Ÿï¼Œæ¯•ç«Ÿå½“å‰çš„æˆ‘æ²¡æœ‰å¿…è¦ä¹Ÿæ²¡æœ‰èƒ½åŠ›åšåˆ°åˆ›æ–°ã€‚æ‰€ä»¥ä¸‹ä¸ªéƒ¨åˆ†ä¸€å®šè¦å¤ä¹ äº†è®ºæ–‡å†åšï¼

2. **æ‹’ç»çº¿æ€§æ€ç»´**

    åœ¨æœ€å¼€å§‹çš„å®ç°ä¸­ï¼Œæ²¡æœ‰æ·±åˆ»åœ°ç†è§£äº‹ä»¶é©±åŠ¨ç¼–ç¨‹çš„å¼ºå¤§ä¹‹å¤„ï¼Œä½¿ç”¨äº†å¾ˆå¤šçº¿æ€§æ€æƒ³ã€‚
    
    æ¯”å¦‚åœ¨`Raft.Start`ä¸­ï¼Œæœ€å¼€å§‹çš„å®ç°æ˜¯åœ¨leaderä¸ºæœ¬åœ°çš„logæ·»åŠ entryæ—¶ç«‹åˆ»å¯åŠ¨å¯¹followerçš„è¿½åŠ ã€‚è¿™æ ·åšçš„åæœæ˜¯å®ç°èµ·æ¥éå¸¸å¤æ‚ï¼Œåœ¨ä¸€ä¸ªå‡½æ•°ä¸­æ—¢è¦å¤„ç†æ·»åŠ åŒæ—¶è¿˜è¦å¤„ç†å¤šä¸ªå‘èµ·çš„åç¨‹çš„ä¸­æ­¢å¤„ç†ç­‰ç­‰ï¼Œæ€»ä¹‹å°±æ˜¯ä¸ºäº†åŒæ­¥çŠ¶æ€è¦èŠ±è´¹éå¸¸å¤šçš„ç²¾åŠ›ã€‚

    æ­£ç¡®çš„å®ç°æ˜¯åœ¨`Raft.Start`ä¸­ï¼Œleaderæ·»åŠ å®Œæœ¬åœ°entryä¹‹åç«‹åˆ»è¿”å›ï¼Œç„¶åç”±å¦å¤–ä¸€ä¸ªå•ç‹¬çš„åç¨‹å®ŒæˆåŒæ­¥ä»»åŠ¡ã€‚è¿™ä¸ªå•ç‹¬çš„åç¨‹åä¸º`Raft.syncEntries`ï¼Œæ˜¯part Bæœ€ä¸ºé‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå®šæœŸåŒæ­¥leaderå’Œfollowerçš„logçŠ¶æ€ï¼ŒåŒæ—¶å……å½“åŸæœ¬çš„heart beatåŠŸèƒ½ã€‚å½“å®ƒæ£€æŸ¥åˆ°leaderçš„ä¸‹æ ‡è¶…è¿‡followeræ—¶è‡ªç„¶ä¼šå¯åŠ¨å¯¹followerçš„è¿½åŠ ï¼Œç„¶åå®šæœŸæ£€æŸ¥æ˜¯å¦æœ‰æ»¡è¶³commitæ¡ä»¶çš„æ¡ç›®ï¼Œæ›´æ–°leaderçš„`commitIndex`ã€‚å†æœ‰ä¸€ä¸ªå•ç‹¬çš„åç¨‹æ£€æŸ¥`commitIndex`å’Œ`lastApplied`çš„å…³ç³»ï¼Œè‡ªåŠ¨å¤„ç†applyã€‚

    æ•´ä¸ªç³»ç»Ÿå¤„äºäº‹ä»¶é©±åŠ¨ä¸­ï¼Œç”±å¤šä¸ªåç¨‹è‡ªåŠ¨æ£€æŸ¥äº‹ä»¶æ˜¯å¦å‘ç”Ÿï¼šé€‰ä¸¾è¶…æ—¶ï¼Œlogå¢åŠ ï¼ŒcommitIndexå¢åŠ ç­‰ç­‰ã€‚ä¸å¾—ä¸è¯´äº‹ä»¶é©±åŠ¨ç¼–ç¨‹çœŸæ˜¯ä¼Ÿå¤§çš„å‘æ˜

3. **æ‹’ç»è¿‡æ—©ä¼˜åŒ–**

    > è¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æº

    äº‹å®å¦‚æ­¤ï¼Œåœ¨å®ç°è¿‡ç¨‹ä¸­ï¼Œè‡³å°‘èŠ±äº†ä¸‰å››ä¸ªå°æ—¶åœ¨æ— æ„ä¹‰çš„è¿‡æ—©ä¼˜åŒ–ä¸­ã€‚

    æ¯”å¦‚åœ¨å®ç°ä¸­æˆ‘å‘ç°Raftä¸­çš„æœ‰äº›çŠ¶æ€æ¯”å¦‚è¯´å½“å‰çš„è§’è‰²ï¼Œå½“å‰çš„ä»»æœŸç­‰åœ¨å¾ˆå¤šäº‹ä»¶æ£€æŸ¥ä¸­éƒ½æ˜¯åªè¯»çš„ï¼Œå¾ˆè‡ªç„¶åœ°å°±æƒ³åˆ°æ¨¡ä»¿æ¡†æ¶ä¸­çš„`Raft.killed`å‡½æ•°å¯¹è¿™äº›çŠ¶æ€åšä¸€ä¸‹åŸå­åŒ–çš„æ£€æŸ¥å’Œæ›´æ”¹ã€‚

    ç¬¬ä¸€ä¸ªé‡åˆ°çš„é—®é¢˜æ˜¯goçš„åŸå­æ“ä½œåªæ”¯æŒ`int32`,`int64`è¿™æ ·ä¸¥æ ¼æŒ‡å®šäº†å­—é•¿çš„ç±»å‹ï¼Œè€Œæˆ‘åœ¨æ—©æœŸç¼–å†™æ—¶å›¾æ–¹ä¾¿ç”¨äº†`int`ã€‚è€Œgoä¸­`int`ååä¸æ˜¯`int32`çš„ç®€å•åˆ«åã€‚è¿™å°±å¯¼è‡´goçš„åŸå­æ“ä½œåŒ…æ‹’ç»æ¥å—ä»¥`int`ä¸ºç±»å‹çš„å¯¹è±¡ï¼Œè€Œæˆ‘åˆä¸æƒ³å¼•å…¥unsafeåŒ…æ¥å¼ºåˆ¶è½¬æ¢ï¼Œæ‰€ä»¥åªèƒ½æŠŠæ‰€æœ‰çš„`int`éƒ½ä¿®æ”¹ä¸ºäº†`int32`

    ç¬¬äºŒä¸ªé‡åˆ°çš„é—®é¢˜æ˜¯æœ‰çš„æ•°æ®åœ¨ä»£ç ä¸­è¢«å¼•ç”¨äº†å¤ªå¤šæ¬¡ï¼Œè¦ä¿®æ”¹å…¨éƒ¨å¤ªè¿‡å›°éš¾ï¼Œç‰¹åˆ«æ˜¯å½“å‰çš„ä»»æœŸï¼ŒåŸæ¥çš„é€‰ä¸¾ç³»ç»Ÿå¤§é‡åœ°å¼•ç”¨è¿™ä¸ªå˜é‡ã€‚è™½ç„¶ideçš„å¼•ç”¨æŸ¥è¯¢å¾ˆå¥½ç”¨ï¼Œä½†ä»æ˜¯ä¸€ä¸ªè‰°éš¾çš„è¿‡ç¨‹

    ç„¶è€Œåœ¨å¤„ç†äº†è¿™ä¹ˆå¤šé—®é¢˜ä¹‹åï¼Œåœ¨å¼€å¯raceæ£€æŸ¥åä»ç„¶å‡ºç°äº†race conditionã€‚åœ¨å¤šæ¬¡å°è¯•å¤„ç†æœªæœåè¿˜æ˜¯æ”¾å¼ƒäº†åŸå­åŒ–çš„æ£€æŸ¥å’Œæ›´æ”¹

    è™½ç„¶åœ¨åŸå­åŒ–çš„æ£€æŸ¥å’Œæ›´æ”¹ä¸ŠèŠ±è´¹äº†å¤§é‡æ—¶é—´ï¼Œä½†äº‹å®è¡¨æ˜è¿™æ˜¯æ— ç”¨åŠŸã€‚åœ¨å®ç°ä¸€ä¸ªç³»ç»Ÿæ—¶ï¼Œåº”è¯¥æŠŠå®ç°åŠŸèƒ½æ”¾åœ¨ç¬¬ä¸€ä½ï¼Œè€Œä¸”MITçš„æ•™æˆä¹Ÿå¤šæ¬¡è¯´äº†labçš„æµ‹è¯•ä¸çœ‹é‡æ•ˆç‡ã€‚è€Œä¸”åœ¨ç¼–å†™çš„æ—¶å€™ä¸€ç›´åœ¨æ€è€ƒè¦æ€ä¹ˆä¼˜é›…åœ°å†™goï¼Œåé¢æƒ³äº†æƒ³æˆ‘éƒ½å†™goäº†è¿˜è¦ä»€ä¹ˆä¼˜é›…ï¼Œå°±ç®—ä»£ç é•¿å¾—è·ŸHTMLä¸€æ ·åˆæ€ä¹ˆæ ·ï¼Œèƒ½è·‘å°±è¡Œï¼

    æ€»ä¹‹è¦æ‹’ç»è¿‡æ—©ä¼˜åŒ–

4. **ç¼–ç¨‹åŸºç¡€è¿˜æ˜¯è¦ç‰¢å›º**

    åœ¨debugçš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°äº†å‡ å¤„é”™è¯¯æ˜¯ç”±äºä¸ç‰¢å›ºçš„åŸºç¡€å¯¼è‡´çš„

    æ¯”å¦‚åœ¨git commitè®°å½•ä¸­å¯ä»¥çœ‹åˆ°ä¿®äº†å¥½å‡ æ¬¡index out of rangeé”™è¯¯ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ä½¿ç”¨ä¸‹æ ‡è®¿é—®æ•°ç»„ï¼ˆåˆ‡ç‰‡ï¼‰æ—¶æ²¡æœ‰ä¸‹æ„è¯†åœ°æ£€æŸ¥ä¸‹æ ‡çš„åˆæ³•æ€§å¯¼è‡´çš„ï¼Œè¿™ä¸ªé”™è¯¯æ˜¾ç„¶æ˜¯èƒ½å¤Ÿé€šè¿‡è‰¯å¥½çš„ç¼–ç¨‹ä¹ æƒ¯è§£å†³çš„

    è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ·±æµ…æ‹·è´å¸¦æ¥çš„å›°æ‰°ã€‚åœ¨åˆ›å»ºä¸€ä¸ªAppendEntriesArgsçš„æ—¶å€™ï¼Œä¸º`Entries`èµ‹å€¼æ—¶ä½¿ç”¨ç®€å•çš„`rf.log[rf.nextIndex[i]:]`åˆ›å»ºçš„æ˜¯å¯¹logçš„æµ…æ‹·è´ã€‚å› ä¸ºåœ¨å‘é€RPCçš„æ—¶å€™å‡ºäºæ•ˆç‡è€ƒè™‘æ˜¯æ²¡æœ‰è¿›è¡Œé”ä¿æŠ¤çš„ï¼Œè¿™æ—¶å¦‚æœæœ‰æŸä¸ªåç¨‹æ›´æ”¹äº†logï¼Œå°±ä¼šå¯¼è‡´æ•°æ®ç«äº‰ã€‚æ­£ç¡®çš„åšæ³•æ˜¯å®Œæ•´åœ°ä¸ºAppendEntriesArgsçš„`Entries`å‚æ•°å¤åˆ¶ä¸€ä»½å®Œæ•´çš„æ·±æ‹·è´ï¼Œæ¯”å¦‚ä½¿ç”¨`append([]logEntry(nil), rf.log[rf.nextIndex[i]:]...)`

    åªå¯¹æ‰€æœ‰èƒ½æƒ³åˆ°çš„æƒ…å†µè¿›è¡Œå¤„ç†ï¼Œå¯¹æ²¡æœ‰é¢„æœŸçš„æƒ…å†µæŠ›å‡ºä¸€ä¸ª`no implementation`é”™è¯¯ï¼Œè¿™åœ¨å¼€å‘çš„æ—¶å€™å®šä½é—®é¢˜æ˜¯ååˆ†é‡è¦çš„

å¤§æ¦‚å°±ä»¥ä¸Šå‡ ç‚¹å§ï¼Œè¿™ä¸ªpartç¡®å®éš¾å•Šï¼Œä½†æ˜¯ä¸€æƒ³åˆ°åªè¦å®ç°äº†è¿™ä¸ªpartè‡³å°‘ç°åœ¨çš„Raftç¡®å®èƒ½å®¹é”™äº†ï¼ˆè™½ç„¶åªå®¹å¿ç½‘ç»œé”™è¯¯ï¼Œä¸èƒ½å®¹å¿å´©æºƒé”™è¯¯ï¼‰

## Part 3C: Pesistence

çº¯çº¯å¥–åŠ±å…³ï¼Œè™½ç„¶æ ‡è®°ä¸ºhardä½†æ˜¯å®é™…ä¸Šåªéœ€è¦åœ¨æ¯ä¸€ä¸ªæ¶‰åŠåˆ°çŠ¶æ€æ›´æ”¹çš„ä½ç½®æ’å…¥`Raft.persist`å°±è¡Œäº†

æˆ‘æ„Ÿè§‰è¿™ä¹ˆç®€å•çš„åŸå› ä¼¼ä¹æ˜¯å› ä¸ºæˆ‘åœ¨3Bå°±å®ç°äº†logçš„å¿«é€ŸåŒæ­¥ï¼Œ3Bä¼¼ä¹å¹¶ä¸è¦æ±‚logå¿«é€ŸåŒæ­¥ï¼Œå…·ä½“çš„åšæ³•å¯ä»¥çœ‹3Bæ˜¯æ€ä¹ˆå®ç°çš„

ä¸è¿‡æœ‰æ„æ€çš„æ˜¯æµ‹è¯•æ¡†æ¶ä¸è¦æ±‚æˆ‘ä»¬å°†ä¿¡æ¯å­˜å‚¨åœ¨ç£ç›˜ä¸­ï¼Œè€Œæ˜¯æäº¤ç»™æ¡†æ¶ä¸­ä¸“é—¨è´Ÿè´£æŒä¹…åŒ–çš„å¯¹è±¡å³å¯ã€‚è¿™å®é™…ä¸Šæœ‰ç‚¹è®©äººä¼¤å¿ƒï¼Œå› ä¸ºæˆ‘çœŸçš„æƒ³è¯•è¯•è®ºæ–‡ä¸­æåˆ°çš„é‚£ä¸ªä½¿ç”¨forkçš„copy-on-writeæ–¹æ¡ˆæ¥ç€ã€‚ã€‚ã€‚

ä¸è¿‡è™½ç„¶å¾ˆç®€å•ï¼Œè¿˜æ˜¯æœ‰ä¸€ä¸ªç»†èŠ‚è¦å¤„ç†

### votedForçš„å­˜å‚¨å’Œæ¢å¤

votedForè¿™ä¸ªå˜é‡æ¯”è¾ƒç‰¹æ®Šï¼Œä¸ºäº†èƒ½è¡¨ç¤ºæ— æŠ•ç¥¨çš„æƒ…å†µï¼Œå…¶è¢«è®¾ç½®ä¸ºæŒ‡é’ˆç±»å‹çš„ï¼ŒæŒ‡å‘å½“å‰ä»»æœŸæŠ•ç¥¨çš„æœºå™¨IDï¼Œ**å¦‚æœå½“å‰ä»»æœŸæ²¡æœ‰æŠ•ç¥¨åˆ™ä¸ºnil**ï¼Œæ‰€ä»¥åœ¨å­˜å‚¨æ—¶è¦ç‰¹æ®Šå¤„ç†nilçš„æƒ…å†µ

æˆ‘çš„åšæ³•æ˜¯å°†ä¸ºnilçš„votedForå­˜å‚¨æ—¶è®¾ä¸º-1

```go
    if rf.votedFor == nil {
        e.Encode(-1)
    } else {
        e.Encode(*rf.votedFor)
    }
```

è¯»å–æ—¶åªéœ€è¦åœ¨è§£ç æ—¶å¯¹-1ç‰¹æ®Šå¤„ç†å³å¯ï¼ˆè¯è¯´å›æ¥ä¸ºä»€ä¹ˆä¸åœ¨è®¾è®¡æ—¶ç›´æ¥ç”¨-1ä»£è¡¨nilå‘¢ã€‚ã€‚ã€‚å…¶å®æ˜¯å› ä¸ºpaperè¯´æ˜¯è¦ç”¨æŒ‡é’ˆï¼Œå…¶å®å®ç°æ—¶æ²¡å¿…è¦ä¸¥æ ¼éµå®ˆï¼‰

```go
    var tmp int
    var _votedFor *int
    if d.Decode(&tmp) != nil {
        log.Printf("[%v] readPersist failed", rf.me)
        return
    }
    if tmp == -1 {
        _votedFor = nil
    } else {
        _votedFor = &tmp
    }

    rf.votedFor = _votedFor
```

goçš„GCæœºåˆ¶ä¿éšœäº†è¿™ä¹ˆè‡ªç”±çš„å†™æ³•ï¼Œå¯ä»¥éšæ„å¼•ç”¨æŸä¸ªå‡½æ•°çš„å±€éƒ¨å˜é‡ï¼Œè€Œc++å°±è¦ç”¨æ™ºèƒ½æŒ‡é’ˆæ‰èƒ½åšåˆ°è¿™æ ·çš„æ“ä½œ

## Part 3D

æœ€åä¸€ä¸ªé˜¶æ®µï¼Œæ•´ä½“å®ç°èµ·æ¥æ€è·¯æŒºæ¸…æ™°çš„ï¼Œä½†æœ€ååœ¨ä¸€ä¸ªå°ç»†èŠ‚ä¸Šå¡äº†åŠå¤©

### å…¨å±€ä¸‹æ ‡ä¸æœ¬åœ°ä¸‹æ ‡

>A good place to start is to modify your code to so that it is able to store just the part of the log starting at some index X. Initially you can set X to zero and run the 3B/3C tests. Then make Snapshot(index) discard the log before index, and set X equal to index. If all goes well you should now pass the first 3D test.

Hintçš„è¿™æ®µè¯æ˜ç¡®äº†æˆ‘ä»¬å¼€å§‹çš„åœ°æ–¹

å› ä¸ºæ—¥å¿—å‹ç¼©ä¼šä¸¢å¼ƒä¹‹å‰çš„æ—¥å¿—ï¼Œ æ‰€ä»¥ä¸åŒæœºå™¨ä¸Šçš„æ—¥å¿—é•¿åº¦å¯èƒ½ä¼šä¸åŒã€‚å› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ä¸ªåœ¨è½¬æ¢çš„æœºåˆ¶

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºç³»ç»Ÿä¸­æ‰€æœ‰æ¶‰åŠè¿è¡Œé€»è¾‘çš„ä¸‹æ ‡éƒ½æ˜¯**å…¨å±€ä¸‹æ ‡**ï¼Œè€Œåœ¨çœŸæ­£è®¿é—®æ—¥å¿—æ—¶ï¼Œä½¿ç”¨**æœ¬åœ°ä¸‹æ ‡**ã€‚æ¯”å¦‚è¯´åŸæœ¬ä¸€ä¸ªæ—¥å¿—æœ‰äº”ä¸ªæœ‰æ•ˆæ¡ç›®ï¼Œå‹ç¼©äº†å‰ä¸‰æ¡ï¼Œè¿™æ—¶ç¬¬å››æ¡çš„æœ¬åœ°ä¸‹æ ‡ä¸º#1,è€Œå…¨å±€ä¸‹æ ‡ä»ç„¶ä¸º#4ï¼ˆä¸‹æ ‡ä»1å¼€å§‹ï¼‰

åªä¿®æ”¹è®¿é—®æ—¥å¿—æ—¶çš„ä¸‹æ ‡å¯ä»¥å°½å¯èƒ½å°åœ°å‡å°‘éœ€è¦æ›´æ”¹çš„ä»£ç ï¼Œå› ä¸ºæ‰€æœ‰æ¶‰åŠè¿è¡Œé€»è¾‘çš„åœ°æ–¹åŸºæœ¬éƒ½å¯ä»¥ä¸æ›´æ”¹

ä¸ºäº†è¿›è¡Œè½¬æ¢ï¼Œè®¾è®¡äº†ä»¥ä¸‹ä¸‰ä¸ªå‡½æ•°ï¼Œå…¶ä¸­`rf.snapshotIndex`æ˜¯ä¸Šæ¬¡snapshotæ“ä½œæ‰€åˆ é™¤çš„æœ€åä¸€æ¡æ—¥å¿—çš„**å…¨å±€ä¸‹æ ‡**

```go
func (rf *Raft) localIndex(globalIndex int) int {
    return globalIndex - rf.snapshotIndex
}

func (rf *Raft) globalIndex(localIndex int) int {
    return localIndex + rf.snapshotIndex
}

func (rf *Raft) globalLogLen() int {
    return len(rf.log) + rf.snapshotIndex
}

```

`Raft.globalLogLen`æ˜¯å› ä¸ºä¹‹å‰çš„å®ç°ä¸­æœ‰ä¸€äº›ä¸‹æ ‡çš„è®¡ç®—æ¶‰åŠåˆ°logé•¿åº¦ï¼Œå°†`len(rf.log)`æ›¿æ¢ä¸ºè¯¥å‡½æ•°ï¼Œèƒ½å‡å°‘è¦ä¿®æ”¹çš„åœ°æ–¹ã€‚ä»¥ä¸Šä¸‰ä¸ªå‡½æ•°éƒ½éœ€è¦åœ¨æŒæœ‰é”çš„æƒ…å†µä¸‹è®¿é—®

å°†æ‰€æœ‰å¯¹æ—¥å¿—çš„è®¿é—®çš„ä¸‹æ ‡éƒ½ä¿®æ”¹ä¸ºå…ˆé€šè¿‡`rf.globalIndex`è½¬æ¢ï¼Œæ‰€æœ‰çš„`lenï¼ˆrf.log)`éƒ½æ›¿æ¢ä¸º`rf.glbalLogLen()`å³å¯

å¥½å§ï¼Œå…¶å®è¿™ä¸ªè¿‡ç¨‹æŒºéº»çƒ¦çš„ã€‚ã€‚ã€‚

### å­˜å‚¨snapshot

snapshotç³»ç»Ÿè¿è¡Œçš„é€»è¾‘æ˜¯ç”±ä¸Šå±‚åº”ç”¨å°†å½“å‰ç³»ç»Ÿçš„çŠ¶æ€æ‰“åŒ…åˆ¶ä½œæˆsnapshotï¼Œç„¶åå‘é€ç»™Raftï¼Œè¦æ±‚RaftæŒä¹…åŒ–å­˜å‚¨snapshotï¼Œå¹¶åœ¨é‡å¯æ—¶å°†snapshotå‘é€ç»™ä¸Šå±‚åº”ç”¨

å› ä¸ºä¹‹åæœ‰æŠŠsnapshotå‘é€ç»™åˆ«çš„æœºå™¨çš„éœ€æ±‚ï¼Œæ‰€ä»¥å½“å‰çš„snapshotä¹Ÿéœ€è¦é©»ç•™åœ¨å†…å­˜ä¸­ï¼Œä½¿ç”¨ä¸€ä¸ªæ–°çš„å±æ€§`Raft.snapshot`æ¥è®°å½•ï¼ŒåŒæ—¶è¿˜è¦æŒä¹…åŒ–åœ°è®°å½•ä¸¤ä¸ªsnapshotçš„å…ƒæ•°æ®ï¼š`Raft.snapshotTerm`->*snapshotåˆ›å»ºæ—¶çš„ä»»æœŸ*ï¼Œ`Raft.snapshotIndex`->*snapshotæ›¿ä»£çš„æœ€åä¸€æ¡æ—¥å¿—çš„ä¸‹æ ‡*ã€‚è¦å°†è¿™ä¸¤ä¸ªå…ƒæ•°æ®åŠ å…¥åˆ°part 3Cçš„æŒä¹…åŒ–æœºåˆ¶ä¸­ï¼Œåœ¨é‡å¯æ—¶è¯»å‡º

æµ‹è¯•æ¡†æ¶ç‰¹æ„ä¸ºsnapshotä¸“é—¨è®¾è®¡äº†å­˜å‚¨æ¥å£ï¼Œæˆ‘çŒœåº”è¯¥æ˜¯ä¸ºäº†å‡å°‘å¤åˆ¶ç”¨çš„ï¼Œä¸è¿‡æˆ‘å¥½åƒæ²¡æœ‰ä½“ä¼šåˆ°åˆ†ç¦»è®¾è®¡çš„å¥½å¤„ï¼Œæ„Ÿè§‰ä¸å¦‚å’Œpart 3Cå…±ç”¨ä¸€ä¸ªé€»è¾‘ã€‚ã€‚ã€‚

### æ¥å—InstallSnapshot

æ­¤å¤„å…ˆè®²è¿°æ¥æ”¶åˆ°InstallSnapshot RPCçš„æœºå™¨çš„è¡Œä¸º

åŸºæœ¬ä¸Šå°±æ˜¯æŒ‰ç…§è®ºæ–‡Figure 13çš„æŒ‡å¯¼æ¥å®Œæˆ

![](/assets/images/2024-09-26-raft/Figure2.png)

ä¸è¿‡å‡ºäºå®ç°æ–¹ä¾¿ï¼Œæˆ‘ä»¬ä¸éœ€è¦å®ç°åˆ†æ®µå‘é€çš„åŠŸèƒ½ï¼Œå³æˆ‘ä»¬ä¸éœ€è¦`offset`,`done`ç”¨æ¥æ§åˆ¶åˆ†æ®µå‘é€ï¼Œä¹Ÿæ— éœ€å…³å¿ƒ2,3,4,5è¿™äº›ä¸åˆ†æ®µå‘é€æœ‰å…³çš„ç‚¹

é¦–å…ˆè¦è¿›è¡ŒçŠ¶æ€æ£€æŸ¥

å¦‚æœæ¥å—è€…çš„ä»»æœŸæ›´é«˜ï¼Œæ˜¾ç„¶è¦æ‹’ç»è¿™ä¸ªè¯·æ±‚

å¦‚æœæ¥å—è€…å½“å‰çš„snapshotIndexæ¯”LastIncludeIndexè¿˜é«˜ï¼Œä¹Ÿè¦æ‹’ç»è¯·æ±‚

ç¬¬å…­ç‚¹å‘Šè¯‰æˆ‘ä»¬å¦‚æœå½“å‰çš„æ—¥å¿—æœ‰åŒ…å«è¯¥snapshotä¹‹åçš„å†…å®¹ï¼Œè¦ä¿ç•™è¿™äº›æ¡ç›®ï¼Œåˆ é™¤å…¶ä»–æ¡ç›®ã€‚å¦‚æœä¸åŒ…å«åˆ™ç›´æ¥åˆ é™¤æ‰€æœ‰çš„æ—¥å¿—

æ¥ç€æ›´æ–°çŠ¶æ€ï¼ŒæŒä¹…åŒ–å­˜å‚¨ï¼Œç„¶åå‘é€ç»™ä¸Šå±‚åº”ç”¨å³å¯

æ³¨æ„æ›´æ–°çŠ¶æ€æ—¶ä¹Ÿè¦é¡ºä¾¿æ›´æ–°`Raft.lastApplied`å’Œ`Raft.commitIndex`ä¸ºå‚æ•°ä¸­çš„ä¸‹æ ‡ï¼Œå› ä¸ºé€»è¾‘ä¸Šå°±æ˜¯å®Œæˆäº†å¯¹è¿™ä¸ªä¸‹æ ‡ä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—çš„åº”ç”¨å’Œæäº¤

### å‘é€InstallSnapshot

å‘é€InstallSnapshotçš„æ—¶æœºæ˜¯æŒºéº»çƒ¦çš„ä¸€éƒ¨åˆ†ï¼Œæƒ³äº†å¾ˆä¹…æ‰æ‰¾åˆ°æ­£è§£

åŸºæœ¬çš„æƒ³æ³•å°±æ˜¯æŠŠå…¶ä½œä¸ºåŒæ­¥æ—¥å¿—æ—¶å¤„ç†é”™è¯¯è¿”å›å€¼çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µæ¥å¤„ç†

åœ¨æˆ‘çš„å®ç°ä¸­ï¼ŒåŒæ­¥æ—¥å¿—ä¼šé‡åˆ°å››ç§é”™è¯¯ï¼Œå…¶ä¸­ä¸¤ç§éœ€è¦ä½¿ç”¨`reply.PrevLogIndex`ä¹‹åçš„æ—¥å¿—æ¡ç›®æ¥ä¿®æ­£ï¼Œå¦å¤–ä¸¤ç§éœ€è¦ä½¿ç”¨`reply.LastApplied`ä¹‹åçš„æ—¥å¿—æ¡ç›®æ¥ä¿®æ­£

å…³é”®å°±åœ¨äºå¦‚æœ`reply.PrevLogIndex`æˆ–è€…`reply.LastApplied`æ‰€æ¶‰åŠçš„æ—¥å¿—å·²ç»**å› ä¸ºsnapshotè€Œåˆ é™¤æ—¶**ï¼Œå¯åŠ¨InstallSnapshot RPCä¿®å¤é”™è¯¯ï¼Œæ„Ÿè§‰æœ‰ç‚¹é¡µè¡¨ä¿®å¤çš„æ„æ€äº†ï¼Œå“ˆå“ˆ

æ‰€ä»¥æˆ‘åšçš„ä¿®æ”¹æ˜¯åœ¨å‰é¢çš„å‡ ç§é”™è¯¯æƒ…å†µçš„åˆ¤æ–­ä¸­åŠ å…¥å¯¹è¿™ä¸¤ä¸ªå±æ€§çš„åˆ¤å®šï¼Œå¦‚æœç¡®å®šä¿®æ­£æ‰€éœ€è¦çš„æ—¥å¿—å·²ç»è¢«åˆ é™¤ï¼Œåˆ™è·³è¿‡å½“å‰çš„åˆ¤å®šï¼ˆå› ä¸ºå°±ç®—åˆ¤å®šæˆåŠŸä¹Ÿæ²¡æœ‰æ—¥å¿—ç”¨æ¥ä¿®å¤ï¼‰ï¼Œæœ€ååˆ¤å®šæ˜¯å¦è¦å¯åŠ¨InstallSnapshot

å¤§è‡´çš„ä»£ç å¦‚ä¸‹ï¼Œå‡ºäºç®€ä¾¿ï¼Œä½¿ç”¨isCaseä»£æ›¿åŸæ¥çš„åˆ¤å®šæ¡ä»¶

```go
for !rf.killed() {
    ...
    if rf.localIndex(currReply.PrevLogIndex+1) > 0 && (isCase1 || isCase2) {
        ...
        ä½¿ç”¨`reply.PrevLogIndex`ä¹‹åçš„æ—¥å¿—æ¡ç›®æ¥ä¿®æ­£
        continue
    }

    if rf.localIndex(currReply.LastApplied+1) > 0 && (isCase3 || isCase4) {
        ...
        ä½¿ç”¨`reply.LastApplied`ä¹‹åçš„æ—¥å¿—æ¡ç›®æ¥ä¿®æ­£
        continue
    }

    if rf.localIndex(currReply.PrevLogIndex+1) <= 0 || rf.localIndex(currReply.LastApplied+1) <= 0 {
        ...
        å‘é€InstallSnapshot
        continue
    }
    ...
}
```

### é‡å»ºçŠ¶æ€æœº

åœ¨é‡å¯æ—¶ï¼Œç»è¿‡`rf.readPersist`è¯»å–å®Œæ‰€æœ‰æŒä¹…åŒ–å­˜å‚¨çš„æ•°æ®ï¼Œå°±å¯ä»¥å‘ä¸Šå±‚åº”ç”¨å‘èµ·åº”ç”¨snapshotçš„è¯·æ±‚äº†

å‘èµ·çš„æ–¹æ³•å°±ç®—åœ¨ApplyMsgä¸­è®¾ç½®å¥½å±æ€§ç„¶åé€šè¿‡channelå‘é€å³å¯ï¼ˆä¸è¿‡æš—è—ç„æœºï¼Œè§ä¸‹ä¸€æ®µï¼‰

### ç®¡é“é˜»å¡ï¼ï¼ï¼

åœ¨å®Œæˆè¿™ä¸ªéƒ¨åˆ†æ—¶æœ€å¤§çš„é—®é¢˜å°±æ˜¯å§‹ç»ˆé€šè¿‡ä¸äº†crashæµ‹è¯•ï¼Œæ’æŸ¥äº†åŠå¤©ï¼ˆå¤§æ¦‚ä¸‰å››ä¸ªå°æ—¶ï¼‰ï¼Œæ€»ç®—å®šä½åˆ°äº†é—®é¢˜æ‰€åœ¨

è¿™ä¸€é—®é¢˜å…¶å®åœ¨æ³¨é‡Šä¸­å°±å·²ç»æåŠäº†ï¼š
>// Make() must return quickly, so it should start goroutines<br>// for any long-running work.

æµ‹è¯•æ¡†æ¶è¦æ±‚Makeå‡½æ•°å¿…é¡»å°½å¿«é€€å‡ºï¼Œ**ç„¶åæ‰ä¼šå¯åŠ¨ä¸Šå±‚åº”ç”¨æ¥æ”¶ç®¡é“çš„ä¿¡æ¯**ï¼Œè€Œgoçš„å•ç¼“å†²ç®¡é“åªè¦æ²¡æœ‰æ¥å—è€…å°±ä¼šä¸€ç›´é˜»å¡

æ‰€ä»¥ä¸‹é¢è¿™æ ·çš„ä»£ç **ä¼šå¯¼è‡´æœºå™¨å§‹ç»ˆå¤„äºé˜»å¡çŠ¶æ€ï¼Œæ— æ³•æ­£å¸¸å¯åŠ¨**ï¼š

```go
// wrong code inside Make()
if len(rf.snapshot) != 0 {
    log.Printf("[%v] try to rebuild state machine from snapshot", rf.me)
    applyCh <- ApplyMsg{
        CommandValid:  false,
        SnapshotValid: true,
        Snapshot:      rf.snapshot,
        SnapshotTerm:  rf.snapshotTerm,
        SnapshotIndex: rf.snapshotIndex,
    }
    rf.commitIndex = rf.snapshotIndex
    rf.lastApplied = rf.snapshotIndex

    log.Printf("[%v] rebuild state machine from snapshot", rf.me)
}
```

è¦ä¿®æ­£è¿™ä¸€é”™è¯¯ï¼Œåªéœ€è¦å°†å‘é€æ”¹ä¸ºåœ¨åç¨‹ä¸­è¿è¡Œå³å¯ï¼š

```go
if len(rf.snapshot) != 0 {
    // ********VERY VERY IMPORTANT!!!!!!!!!!!!!!!!!!!!!!!!!*******
    // Make() must return quickly, so it should start goroutines
    // for any long-running work.
    // applyCh will receive ApplyMsg only after Make() is done
    // So we need to start goroutine to send ApplyMsg
    // Took me about 3 hours to find this problem
    go func() {
        log.Printf("[%v] try to rebuild state machine from snapshot", rf.me)
        applyCh <- ApplyMsg{
            CommandValid:  false,
            SnapshotValid: true,
            Snapshot:      rf.snapshot,
            SnapshotTerm:  rf.snapshotTerm,
            SnapshotIndex: rf.snapshotIndex,
        }
        rf.commitIndex = rf.snapshotIndex
        rf.lastApplied = rf.snapshotIndex

        log.Printf("[%v] rebuild state machine from snapshot", rf.me)
    }()
}
```

è™½ç„¶æ˜¯ä¸€ä¸ªå¾ˆå°çš„é”™è¯¯ï¼Œä½†çœŸçš„èŠ±äº†æˆ‘å¾ˆå¤šçš„ç²¾åŠ›æ¥å®šä½é”™è¯¯ï¼Œä¸‹æ¬¡ç»å¯¹ä¸ä¼šçŠ¯äº†

åŒæ—¶ç»è¿‡æ’æŸ¥ï¼Œåœ¨`Raft.applyEntries`ä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„é”™è¯¯ï¼š**åœ¨æŒæœ‰é”çš„æƒ…å†µä¸‹è¿›è¡Œç®¡é“å‘é€æ“ä½œ**ï¼Œè™½ç„¶ä¸ä¿®æ­£ä¹Ÿèƒ½ä¾¥å¹¸é€šè¿‡æµ‹è¯•ï¼Œä½†æ˜¯è°çŸ¥é“æ—¥åä¸ä¼šå‡ºé—®é¢˜å‘¢

## æ€§èƒ½ä¼˜åŒ–

è‡³æ­¤æ‰€æœ‰çš„å·¥ä½œå…¶å®å·²ç»å®Œæˆäº†ï¼Œå·²ç»èƒ½å¤Ÿé€šè¿‡æ‰€æœ‰çš„æµ‹è¯•ã€‚ä¸è¿‡æ•ˆç‡éå¸¸éå¸¸ä½

æŒ‡å¯¼ä¸­è¯´é€šè¿‡æ‰€æœ‰æµ‹è¯•çš„æ—¶é—´åº”è¯¥åœ¨6åˆ†é’Ÿï¼Œè€Œå®é™…ä¸Šæˆ‘èŠ±è´¹äº†9åˆ†é’Ÿã€‚é€šè¿‡shellå†…ç½®çš„timeè¿›è¡Œæ£€æµ‹å‘ç°å®é™…CPUæ—¶é—´åªæœ‰å‡ ç§’ï¼Œä¹Ÿå°±æ˜¯å¤§éƒ¨åˆ†çš„æ—¶é—´éƒ½èŠ±è´¹åœ¨äº†ç¡çœ æˆ–è€…ç­‰å¾…é”ä¸Šã€‚

æ˜¾ç„¶æ˜¯å¯ä»¥ä¼˜åŒ–çš„ï¼Œè‡³å°‘ä¹Ÿè¦è¿›6åˆ†é’Ÿæ‰è¡Œã€‚ã€‚ã€‚